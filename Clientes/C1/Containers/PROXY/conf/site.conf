# --------- SERVER "GENÉRICO" (catch-all) ----------
server {
  listen 80 default_server;
  server_name _;

  # Redireciona / para /portal/
  location = / {
    return 302 /portal/;
  }

  # Portal estático
  location /portal/ {
    alias /usr/share/nginx/html/;
    index index.html;
    # No-cache para HTML do portal
    location ~* \.html?$ {
      add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
      add_header Pragma "no-cache";
      add_header Expires "0";
    }
    # CSP somente para o portal
    add_header Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; base-uri 'self'; object-src 'none'; frame-ancestors 'none'" always;
  }

  # Chegaram "secos" em /wp-admin ou /wp-login? Manda para /cms/...
  location = /wp-admin       { return 301 https://www.bolachaekernel.com/cms/wp-admin/; }
  location = /wp-admin/      { return 301 https://www.bolachaekernel.com/cms/wp-admin/; }
  location = /wp-login.php   { return 301 https://www.bolachaekernel.com/cms/wp-login.php; }

  # WordPress por trás em /cms → http://c1-wp/
  location /cms/ {
    proxy_pass http://c1-wp/;

    # Cabeçalhos de proxy
    proxy_set_header Host               $host;
    proxy_set_header X-Forwarded-Host   $host;
    proxy_set_header X-Forwarded-Proto  https;
    proxy_set_header X-Real-IP          $remote_addr;

    # Cookies escopo "/" para evitar loop (/ e /cms)
    proxy_cookie_path / /;

    # Não tentar reescrever Location automaticamente
    proxy_redirect off;

    # Buffers/timeout
    client_max_body_size 32m;
    proxy_read_timeout 60s;
    proxy_connect_timeout 5s;

    # Segurança (herdado do provedor na borda também)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "no-referrer" always;
  }
}

# --------- SERVER DO DOMÍNIO C1 ----------
server {
  listen 80;
  server_name bolachaekernel.com www.bolachaekernel.com;

  # Raiz → /portal/
  location = / {
    return 302 /portal/;
  }

  # Portal estático
  location /portal/ {
    alias /usr/share/nginx/html/;
    index index.html;
    location ~* \.html?$ {
      add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
      add_header Pragma "no-cache";
      add_header Expires "0";
    }
    add_header Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; base-uri 'self'; object-src 'none'; frame-ancestors 'none'" always;
  }

  # Forçar /cms/ para admin/login “secos”
  location = /wp-admin       { return 301 https://www.bolachaekernel.com/cms/wp-admin/; }
  location = /wp-admin/      { return 301 https://www.bolachaekernel.com/cms/wp-admin/; }
  location = /wp-login.php   { return 301 https://www.bolachaekernel.com/cms/wp-login.php; }

  # WordPress em /cms
  location /cms/ {
    proxy_pass http://c1-wp/;

    proxy_set_header Host               $host;
    proxy_set_header X-Forwarded-Host   $host;
    proxy_set_header X-Forwarded-Proto  https;
    proxy_set_header X-Real-IP          $remote_addr;

    proxy_cookie_path / /;
    proxy_redirect off;

    client_max_body_size 32m;
    proxy_read_timeout 60s;
    proxy_connect_timeout 5s;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "no-referrer" always;
  }
}
