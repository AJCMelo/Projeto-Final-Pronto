# =========================
# 1) VHOST PADRÃO (catch-all)
# =========================
<VirtualHost *:80>
    ServerName _catch_all

    # Preserva host/proto originais quando chega via TLS externo (HAProxy)
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
    RequestHeader set X-Forwarded-Host %{Host}s
    SetEnvIf X-Forwarded-Proto "^https$" HTTPS=on

    # Home -> /portal/
    RedirectMatch 302 ^/$ /portal/

    # ---- Portal estático ----
    Alias /portal/ "/usr/local/apache2/htdocs/"
    Alias /portal  "/usr/local/apache2/htdocs/index.html"

    <Directory "/usr/local/apache2/htdocs">
        Options FollowSymLinks
        AllowOverride None
        Require all granted
        DirectoryIndex index.html

        # Não cachear HTML do portal
        <FilesMatch "\.html?$">
            Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
            Header set Pragma "no-cache"
            Header set Expires "0"
        </FilesMatch>

        # CSP somente para o /portal (permite CSS inline)
        Header always unset Content-Security-Policy
        Header always set Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; base-uri 'self'; object-src 'none'; frame-ancestors 'none'"
    </Directory>

    # ---- WordPress em /cms ----
    # Guarda de caminho (força prefixo /cms e HTTPS caso chegue “seco”)
    RedirectMatch 301 ^/wp-admin/?(.*)$ https://www.chaekernel.com/cms/wp-admin/$1
    RedirectMatch 301 ^/wp-login\.php(.*)$ https://www.chaekernel.com/cms/wp-login.php$1

    # Mapeamento 1:1 do path (/cms/<...> → http://c2-wp/<...>)
    ProxyPassMatch ^/cms/(.*)$ http://c2-wp/$1
    ProxyPassReverse /cms/ http://c2-wp/
    ProxyPassReverse /cms/ https://c2-wp/
    ProxyPassReverseCookiePath / /cms/
    ProxyPassReverseCookieDomain c2-wp www.chaekernel.com

    # --- Correções de Location vindos do backend ---
    # /wp-admin/ "seco" → login com redirect_to relativo (sem %)
    Header edit Location "^/wp-admin/?$" "/cms/wp-login.php?redirect_to=/cms/wp-admin/"
    Header edit Location "^https?://www\.chaekernel\.com/wp-admin/?$" "https://www.chaekernel.com/cms/wp-login.php?redirect_to=/cms/wp-admin/"
    Header edit Location "^/cms/wp-admin/?$" "/cms/wp-login.php?redirect_to=/cms/wp-admin/"
    Header edit Location "^https?://www\.chaekernel\.com/cms/wp-admin/?$" "https://www.chaekernel.com/cms/wp-login.php?redirect_to=/cms/wp-admin/"

    # Demais /wp-admin/<algo> → /cms/wp-admin/<algo>
    Header edit Location "^/wp-admin/(.+)$" "/cms/wp-admin/$1"
    Header edit Location "^https?://www\.chaekernel\.com/wp-admin/(.+)$" "https://www.chaekernel.com/cms/wp-admin/$1"

    # /wp-login.php (com ou sem query) → /cms/wp-login.php (preserva query)
    Header edit Location "^/wp-login\.php(.*)$" "/cms/wp-login.php$1"
    Header edit Location "^https?://www\.chaekernel\.com/wp-login\.php(.*)$" "https://www.chaekernel.com/cms/wp-login.php$1"

    ProxyTimeout 60
</VirtualHost>


# =========================
# 2) VHOST DO DOMÍNIO — produção
# =========================
<VirtualHost *:80>
    ServerName www.chaekernel.com
    ServerAlias chaekernel.com

    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
    RequestHeader set X-Forwarded-Host %{Host}s
    SetEnvIf X-Forwarded-Proto "^https$" HTTPS=on

    # Home -> /portal/
    RedirectMatch 302 ^/$ /portal/

    # ---- Portal estático ----
    Alias /portal/ "/usr/local/apache2/htdocs/"
    Alias /portal  "/usr/local/apache2/htdocs/index.html"

    <Directory "/usr/local/apache2/htdocs">
        Options FollowSymLinks
        AllowOverride None
        Require all granted
        DirectoryIndex index.html

        <FilesMatch "\.html?$">
            Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
            Header set Pragma "no-cache"
            Header set Expires "0"
        </FilesMatch>

        # CSP somente para o /portal (permite CSS inline)
        Header always unset Content-Security-Policy
        Header always set Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; base-uri 'self'; object-src 'none'; frame-ancestors 'none'"
    </Directory>

    # ---- WordPress em /cms ----
    RedirectMatch 301 ^/wp-admin/?(.*)$ https://www.chaekernel.com/cms/wp-admin/$1
    RedirectMatch 301 ^/wp-login\.php(.*)$ https://www.chaekernel.com/cms/wp-login.php$1

    ProxyPassMatch ^/cms/(.*)$ http://c2-wp/$1
    ProxyPassReverse /cms/ http://c2-wp/
    ProxyPassReverse /cms/ https://c2-wp/
    ProxyPassReverseCookiePath / /cms/
    ProxyPassReverseCookieDomain c2-wp www.chaekernel.com

    # Correções de Location (sem %)
    Header edit Location "^/wp-admin/?$" "/cms/wp-login.php?redirect_to=/cms/wp-admin/"
    Header edit Location "^https?://www\.chaekernel\.com/wp-admin/?$" "https://www.chaekernel.com/cms/wp-login.php?redirect_to=/cms/wp-admin/"
    Header edit Location "^/cms/wp-admin/?$" "/cms/wp-login.php?redirect_to=/cms/wp-admin/"
    Header edit Location "^https?://www\.chaekernel\.com/cms/wp-admin/?$" "https://www.chaekernel.com/cms/wp-login.php?redirect_to=/cms/wp-admin/"

    Header edit Location "^/wp-admin/(.+)$" "/cms/wp-admin/$1"
    Header edit Location "^https?://www\.chaekernel\.com/wp-admin/(.+)$" "https://www.chaekernel.com/cms/wp-admin/$1"

    Header edit Location "^/wp-login\.php(.*)$" "/cms/wp-login.php$1"
    Header edit Location "^https?://www\.chaekernel\.com/wp-login\.php(.*)$" "https://www.chaekernel.com/cms/wp-login.php$1"

    ProxyTimeout 60
</VirtualHost>
